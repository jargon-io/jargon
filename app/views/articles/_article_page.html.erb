<%# locals: (article:) %>

<div id="article_<%= article.id %>_page" class="w-full max-w-2xl mx-auto">
  <% if article.pending? %>
    <div class="space-y-2">
      <p class="text-sm text-faint break-all"><%= article.url %></p>
      <%= render "shared/loading_placeholder", message: "Loading article..." %>
    </div>
  <% elsif article.failed? %>
    <div class="space-y-3">
      <p class="text-sm text-faint break-all"><%= article.url %></p>
      <div class="p-4 bg-red-50 dark:bg-red-950 border border-red-200 dark:border-red-800 rounded-lg">
        <h2 class="text-lg font-semibold text-red-700 dark:text-red-400">Failed to load article</h2>
        <p class="text-red-600 dark:text-red-500 mt-1"><%= article.user_friendly_error_message %></p>
        <% if article.parsed_error %>
          <details class="mt-3">
            <summary class="text-sm text-red-500 dark:text-red-400 cursor-pointer">Show technical details</summary>
            <div class="mt-2 p-3 bg-red-100 dark:bg-red-900 rounded text-sm font-mono">
              <p class="text-red-700 dark:text-red-300"><%= article.parsed_error[:class] %></p>
              <p class="text-red-600 dark:text-red-400 mt-1"><%= article.parsed_error[:message] %></p>
              <% if article.parsed_error[:occurred_at] %>
                <p class="text-red-500 dark:text-red-500 mt-2 text-xs">
                  <%= Time.parse(article.parsed_error[:occurred_at]).strftime("%B %d, %Y at %H:%M UTC") %>
                </p>
              <% end %>
            </div>
          </details>
        <% end %>
      </div>
      <%= link_to "Read original &rarr;".html_safe, article.url, rel: "noopener", class: "text-link" %>
    </div>
  <% else %>
    <div class="space-y-4">
      <div class="flex items-start gap-2">
        <%= page_icon(article) %>
        <div class="space-y-1">
          <h1 class="text-3xl font-bold text-heading"><%= article.title %></h1>
          <%= render "shared/byline", author: article.author, date: article.published_at %>
        </div>
      </div>

      <% if article.video? && (video_id = article.url&.match(YoutubeClient::URL_REGEX)&.[](1)) %>
        <div class="aspect-video mt-4">
          <iframe
            src="https://www.youtube.com/embed/<%= video_id %>"
            class="w-full h-full rounded-lg"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
          </iframe>
        </div>
      <% elsif article.image_url.present? %>
        <%= image_tag article.image_url, class: "w-full max-h-64 object-contain rounded-lg md:float-right md:w-auto md:max-w-64 md:max-h-48 md:ml-4 md:mb-4" %>
      <% end %>

      <% if article.summary.present? %>
        <p class="text-lg text-body leading-relaxed mt-4"><%= render_content(article.summary, current_item: article) %></p>
      <% end %>

      <% if article.has_children? %>
        <ul class="mt-4">
          <% article.children.each do |child| %>
            <% next if child.url.blank? %>
            <li><%= link_to child.url, child.url, class: "text-link" %></li>
          <% end %>
        </ul>
      <% elsif article.url.present? && !article.video? %>
        <div class="mt-4">
          <% label = article.paper? ? "Read original paper" : "Read original" %>
          <%= link_to label, article.url, rel: "noopener", class: "text-link font-medium" %>
        </div>
      <% end %>

      <% rolled_up = article.rolled_up_insights %>
      <% generating = article.text.present? && article.updated_at > 1.minute.ago %>

      <% if rolled_up.any? %>
        <div class="pt-4">
          <%= render "shared/expandable_list", items: rolled_up do |insight| %>
            <%= render insight, suppress_source: true %>
          <% end %>
        </div>
      <% elsif generating %>
        <div class="pt-4">
          <%= render "shared/loading_placeholder", message: "Generating insights..." %>
        </div>
      <% end %>

      <%= render "shared/section_heading", title: "Explore" %>
      <%= render "searches/explore", source: article, searches: article.searches %>

      <% related_items = article.find_related_items %>
      <% if related_items.any? %>
        <%= render "shared/section_heading", title: "Related" %>
        <%= render "shared/expandable_list", items: related_items do |item| %>
          <%= render "shared/item", item: item %>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>

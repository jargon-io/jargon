<% content_for(:title) { "#{@cluster.name.presence || 'Cluster'} | Jargon" } %>
<div class="w-full max-w-2xl mx-auto space-y-4">
  <h1 class="text-3xl font-bold text-heading"><%= @cluster.name.presence || "Unnamed Cluster" %></h1>

  <% if @cluster.image_url.present? %>
    <%= image_tag @cluster.image_url, class: "float-right ml-4 mb-4 max-h-48 max-w-64 object-contain rounded" %>
  <% end %>

  <% if @cluster.clusterable_type == "Insight" %>
    <% if @cluster.body.present? %>
      <p class="text-lg text-body leading-relaxed"><%= render_content(@cluster.body, current_item: @cluster) %></p>
    <% end %>

    <%= render "shared/snippet", text: @cluster.snippet, current_item: @cluster %>

    <%= render "shared/section_heading", title: "Explore" %>

    <%= render @cluster.research_threads %>

    <%= form_with url: research_threads_path, method: :post, class: "flex gap-2" do |f| %>
      <%= f.hidden_field :subject_type, value: "Cluster" %>
      <%= f.hidden_field :subject_id, value: @cluster.id %>
      <%= f.text_field :query,
          required: true,
          class: "flex-1 py-3 px-5 surface border border-strong rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-300 focus:border-transparent" %>
      <%= f.submit "â†’",
          class: "px-4 py-2 btn-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 cursor-pointer" %>
    <% end %>

    <% if @source_items.any? %>
      <%= render "shared/section_heading", title: "Sources" %>
      <div class="space-y-4 clear-both" data-controller="expandable-list" data-expandable-list-limit-value="3">
        <% @source_items.each do |item| %>
          <div data-expandable-list-target="item">
            <%= render "shared/item", item: item %>
          </div>
        <% end %>
        <%= render "shared/expandable_toggle" %>
      </div>
    <% end %>
  <% else %>
    <% if @cluster.summary.present? %>
      <p class="text-lg text-body leading-relaxed"><%= render_content(@cluster.summary, current_item: @cluster) %></p>
    <% end %>

    <% if @cluster.snippet.present? %>
      <%= render "shared/snippet", text: @cluster.snippet, current_item: @cluster %>
    <% end %>

    <ul class="text-link text-sm space-y-1 clear-both">
      <% @members.each do |article| %>
        <li>
          <%= link_to article.url, article.url, target: "_blank", rel: "noopener", class: "hover:underline break-all" %>
        </li>
      <% end %>
    </ul>

    <% if @insights.any? %>
      <div class="space-y-4 pt-4" data-controller="expandable-list" data-expandable-list-limit-value="3">
        <% @insights.each do |item| %>
          <div data-expandable-list-target="item">
            <%= render "shared/item", item: item, suppress_source: true %>
          </div>
        <% end %>
        <%= render "shared/expandable_toggle" %>
      </div>
    <% end %>
  <% end %>

  <% if @similar_items.any? %>
    <%= render "shared/section_heading", title: "Related" %>
    <div class="space-y-4" data-controller="expandable-list" data-expandable-list-limit-value="3">
      <% @similar_items.each do |item| %>
        <div data-expandable-list-target="item">
          <%= render "shared/item", item: item %>
        </div>
      <% end %>
      <%= render "shared/expandable_toggle" %>
    </div>
  <% end %>
</div>
